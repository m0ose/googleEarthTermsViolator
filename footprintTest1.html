<html>
<head>
<script src="./src/pointInGeoJsonTester.js"></script>
<script src="./bower_components/jstat/dist/jstat.js"></script>
<script src="./bower_components/squareBins/squareBins.js"></script>
<script src="http://underscorejs.org/underscore-min.js"></script>
<script src="src/getElevationFromServer.js"></script>
<script src="./src/miscUtils.js"></script>
<script src="./bower_components/FileSaver/FileSaver.js"></script>
<script src="./bower_components/turf/turf.js"></script>
 <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
 <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>

<!--<script>exports = {}//required for the hilbert curve library</script>
<script src="./bower_components/hilbert-js/hilbert2d.js"></script>
-->
<script>

var geoJsonLookup
var g_elev

function getUrl(url) {
  return new Promise(function(resolve, reject) {
    var req = new XMLHttpRequest();
    req.open('GET', url);
    req.onload = function() {
      if (req.status == 200) {
        // Resolve the promise with the response text
        resolve(req.response);
      }
      else {
        reject(Error(req.statusText));
      }
    };
    req.onerror = function() {
      reject(Error("Network Error"));
    };
    req.send();
  });
}

function loadFootPrints(url) {
    getUrl(url).then(function(response) {
      //console.log("Success!", response);
      var jsn = JSON.parse(response)
      console.log(jsn)
      geoJsonLookup = new pointInGeojsonTester( jsn,{width:400, height:400})
      document.getElementById('can').appendChild( geoJsonLookup.canvas)
      geoJsonLookup.canvas.id = "geojson-canvas"
      geoJsonLookup.centroids2properties()
      geoJsonLookup.canvas.onmousemove = mousemover
      initMap()
    }).catch(function(error) {
      console.error("Failed", error);
    })

    var mousemover =  function(e){
      //console.log(e)
      var bb = this.getBoundingClientRect()
      //console.log(bb)
      var x = e.clientX - bb.left
      var y = e.clientY - bb.top
      var feat = geoJsonLookup.featureOfCanXY(x,y)
      var indx = geoJsonLookup.indexOfCanvasXY(x,y)
      var dv=document.getElementById('results')
      // move map
      //
      if( map && gpopup && feat) {
        var d = getStats( feat.properties)
        var ll = new L.LatLng(feat.properties.clat, feat.properties.clon)
        gpopup.setLatLng(ll)
        gpopup.setContent(d.str)
        map.setView(ll)
      }
    }
}

function getBuildoingStatsCSV() {
  var feat1 = geoJsonLookup.features[0].properties
  var stat1 = getStats(feat1)
  var CSV=""
  for(var i in stat1.buildings){
    CSV += i+","
  }
  CSV += "mean terrain minus mean ground \n"
  for(var i=0; i<geoJsonLookup.features.length; i++) {
    var feat = geoJsonLookup.features[i].properties
    var stats = getStats(feat)
    for(var j in stats.buildings ) {
      var fb = stats.buildings[j] 
      CSV+= Number(fb).toFixed(6) + ", "
    }
    CSV += (stats.terrain.mean-stats.ground.mean).toFixed(6) +"\n"
  }
  return CSV
  //CSV = CSV.slice(0,-1)//get rid of the last comma. Horribly slow
}

function saveNuildingStats() {
  var boo = getBuildoingStatsCSV()
  var blob = new Blob([boo], {type: "text/plain;charset=utf-8"});
  saveAs(blob,"buildingStats.csv")
}

function getStats( featProps) {
  var ground = []
  var terrain = []
  var build = []
  if( featProps.hits) {
    for(var i=0; i < featProps.hits.length; i++) {
      var hit = featProps.hits[i]
      ground.push(hit.g)
      terrain.push(hit.a)
      build.push(hit.a-hit.g)
    }
  }

  function gammot(list) {
    return {
      mean:jStat.mean(list),
      min:jStat.min(list),
      max:jStat.max(list),
      median:jStat.median(list),
      stdev:jStat.stdev(list),
      meddev:jStat.meddev(list)
    }
  }

  bstat = gammot(build)
  gstat = gammot(ground)
  tstat = gammot(terrain)
  //put onto page
  //console.log('building ', bstat)
  //console.log('ground ', gstat)
  //console.log('terrain ', tstat)
  var str2 = " "
  str2 = ' accepted height: ' + featProps.height
  str2 += ' <br> mean height: ' + bstat.mean
  str2 += ' <br> max: ' + bstat.max
  str2 += ' <br> min: ' + bstat.min
  str2 += ' <br> stdev: ' + bstat.stdev
  str2 += ' <br> median: ' + bstat.median
  str2 += ' <br> count: ' + ground.length
  str2 += ' <br> trn_mean - grnd_mean: ' + (tstat.mean - gstat.mean)
  return {str:str2, buildings:bstat, ground:gstat, terrain:tstat}
}


//
var bins
function lookAtFootPrints(lookup) {
  var jsonSamples = lookup.calcCentroids()
  bins = new squareBins({minX:lookup.xMin-0.001, maxX:lookup.xMax+0.001, minY:lookup.yMin-0.001, maxY:lookup.yMax+0.001, width:40, height:40})
  var randSamp 
  for(var i in jsonSamples.allPoints) {
    var sampCount = Math.min(60, jsonSamples.allPointsLatLon[i].length/4)
    randSamp = _.sample(jsonSamples.allPointsLatLon[i], sampCount)
    //console.log(randSamp)
    for(var j=0; j<randSamp.length; j++) {
      bins.addPoint(randSamp[j][1], randSamp[j][0], {lookupIndex:i} )
    }
  }
  console.log(randSamp)
}

loadFootPrints('./data/sanfran-hitTest-4326.json')


drawElevation = function() {
  var can2 = document.getElementById('can2')
  var ctx = can2.getContext('2d')
  for(var x = 0; x<can2.width; x+=2){
    for(var y=0; y<can2.height; y+=2){
        var lon=scaleValue(0, x, can2.width, geoJsonLookup.xMin, geoJsonLookup.xMax)
        var lat=scaleValue(0, y, can2.height, geoJsonLookup.yMin, geoJsonLookup.yMax)
        var elv = g_elev.queryLatLon(lat,lon)
        var rgb = HSVtoRGB(0.2+elv/150, 1, 0.5)
        ctx.fillStyle = "rgb("+rgb.r+","+rgb.g+","+rgb.b+")"
        ctx.fillRect(x,y,2,2)
    }
  }
}

//
// init map
//
var map
var gpopup
function initMap() {
  map = L.map('map1').setView([51.505, -0.09], 13);
  var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  var osmAttrib='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
  var osm = new L.TileLayer(osmUrl, {minZoom: 8, maxZoom: 18, attribution: osmAttrib});   
  map.setView(new L.LatLng( 37.7898253274591, -122.40611229067207 ),15);
  map.addLayer(osm);
  gpopup = L.popup()
    .setLatLng([ 37.7898253274591, -122.40611229067207])
    .setContent("hello")
    .openOn(map)
}
</script>
</head>
<body>
<div id="results" style="position:absolute; left:0px; top:0px; background-color:black; color:white;   border-radius: 5px;"></div>
<div id="can"></div>
<div id="map1" style="height:400px; width:400px"></div>
</body>
</html>







